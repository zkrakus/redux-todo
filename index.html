<!DOCTYPE html>
<html>
    <head>
        <Title>Todo/Goals</Title>
        <script src='https://cdnjs.cloudflare.com/ajax/libs/redux/4.0.5/redux.min.js'></script>

        <script src='https://unpkg.com/react@16.13.1/umd/react.development.js'></script>
        <script src='https://unpkg.com/react-dom@16.13.1/umd/react-dom.development.js'></script>
        <script src='https://unpkg.com/babel-standalone@6.26.0/babel.min.js'></script>
        <script src='https://unpkg.com/redux-thunk@2.3.0/dist/redux-thunk.min.js'></script>
    </head>

    <body>
        <div id='app'/>

        
        <script type="text/javascript">
            (function () {
                window.API = {}

                function fail () {
                    return Math.floor(Math.random()*(5-1)) === 3
                }

                function generateId () {
                    return Math.random().toString(36).substring(2);
                }

                var goals = [
                    {
                    id: generateId(),
                    name: 'Learn Redux',
                    },
                    {
                    id: generateId(),
                    name: 'Read 50 books this year',
                    },
                ];

                var todos = [
                    {
                    id: generateId(),
                    name: 'Walk the dog',
                    complete: false,
                    },
                    {
                    id: generateId(),
                    name: 'Wash the car',
                    complete: false,
                    },
                    {
                    id: generateId(),
                    name: 'Go to the gym',
                    complete: true,
                    }
                ];

                API.fetchGoals = function () {
                    return new Promise((res, rej) => {
                    setTimeout(function () {
                        res(goals)
                    }, 2000)
                    })
                }

                API.fetchTodos = function () {
                    return new Promise((res, rej) => {
                    setTimeout(function () {
                        res(todos)
                    }, 2000)
                    })
                }

                API.saveTodo = function (name) {
                    return new Promise((res, rej) => {
                    setTimeout(() => {
                        const todo = {
                        id: generateId(),
                        name: name,
                        complete: false,
                        }
                        todos = todos.concat([todo]);
                        fail() ? rej(todo) : res(todo);
                    }, 300)
                    })
                }

                API.saveGoal = function (name) {
                    return new Promise((res, rej) => {
                    setTimeout(() => {
                        const goal = {
                        id: generateId(),
                        name: name,
                        }
                        goals = goals.concat([goal]);
                        fail() ? rej(goal) : res(goal);
                    }, 300)
                    })
                }

                API.deleteGoal = function (id) {
                    return new Promise((res, rej) => {
                    setTimeout(() => {
                        goals = goals.filter((goal) => goal.id !== id);
                        fail() ? rej(): res(goals);
                    }, 300)
                    });
                }

                API.deleteTodo = function (id) {
                    return new Promise((res, rej) => {
                    setTimeout(() => {
                        todos = todos.filter((todo) => todo.id !== id);
                        fail() ? rej(): res(todos);
                    }, 300)
                    });
                }

                API.saveTodoToggle = function (id) {
                    return new Promise((res, rej) => {
                        setTimeout(() => {
                            todos = todos.map((todo) => todo.id !== id ? todo :
                                Object.assign({}, todo, {complete: !todo.complete})
                            );

                            fail() ? rej() : res(todos);
                        }, 300)
                    });
                }
            })()
        </script>

        <script type="text/javascript">

            // Helper methods
            function generateId (){
                return Math.random().toString(36).substring(2) + (new Date()).getTime().toString(36);
            }

            // App code
            const ADD_TODO = "AD_TODO";
            const REMOVE_TODO = "REMOVE_TODO";
            const TOGGLE_TODO = "TOGGLE_TODO";
            const ADD_GOAL = "ADD_GOAL";
            const REMOVE_GOAL = "REMOVE_GOAL";
            const RECEIVE_DATA  = "RECEIVE_DATA";

            function addTodoAction (todo) {
            return {
                type: ADD_TODO,
                todo,
            }
            }

            function removeTodoAction (id) {
            return {
                type: REMOVE_TODO,
                id,
            }
            }

            function toggleTodoAction (id) {
            return {
                type: TOGGLE_TODO,
                id,
            }
            }

            function addGoalAction (goal) {
            return {
                type: ADD_GOAL,
                goal,
            }
            }

            function removeGoalAction (id) {
            return {
                type: REMOVE_GOAL,
                id,
            }
            }

            function receiveDataAction( todos, goals){
                return {
                    type: RECEIVE_DATA,
                    goals,
                    todos
                }
            }
            
            function handleDeleteTodo(todo){
                return (dispatch) => {
                    dispatch(removeTodoAction(todo.id))

                    return API.deleteTodo(todo.id)
                        .catch(() =>{
                            dispatch(addTodoAction(todo))
                            alert('An error has occurred. Try again.')
                        })
                }
            }
            
            function handleDeleteGoal(goal){
                return (dispatch) => {
                    dispatch(removeGoalAction(goal.id))

                    return API.deleteGoal(goal.id)
                        .catch(() => {
                            dispatch(addGoalAction(goal))
                            alert('An error has occurred. Try again.')
                        })
                }
            }

            function handleAddGoal(name, cb){
                return (dispatch) => {
                    return API.saveGoal(name)
                        .then((goal) => {
                            dispatch(addGoalAction(goal))
                            cb()
                        })            
                        .catch(() => alert('There was an error. Try again.')) 
                }
            }

            function handleAddTodo(name, cb){
                return (dispatch) => {
                    return API.saveTodo(name)
                        .then((todo) => {
                            dispatch(addTodoAction(todo))
                            cb()
                        })
                        .catch(() => alert('There was an error. Try again.'))
                }
            }

            function handleToggleTodo(id){
                return (dispatch) => {
                    dispatch(toggleTodoAction(id))

                    return API.saveTodoToggle(id)
                        .catch(() => {
                            dispatch(toggleTodoAction(id))
                            alert('There was an error. Try again.')
                        })
                }
            }

            function handleInitialData(){
                return(dispatch)=>{
                    Promise.all([
                        API.fetchTodos(),
                        API.fetchGoals(),
                    ]).then(([todos, goals]) => {
                        store.dispatch(receiveDataAction(todos,goals))
                    })
                }
            }

            // checker middleware
            const checker = (store) => (next) => (action) => {
                if(
                    action.type === ADD_TODO &&
                    action.todo.name.toLowerCase().indexOf('bitcoin') !== -1
                ){
                    return alert("Nope. That's a bad idea.")
                }

                if(
                    action.type === ADD_GOAL &&
                    action.goal.name.toLowerCase().indexOf('bitcoin') !== -1
                ){
                    return alert("Nope. That's a bad idea.")
                }

                return next(action)
            }

            // logger middleware. Implementation requires this to be the last middleware added.
            const logger = (store) => (next) => (action) => {
                console.group(action.type)
                console.log('The action: ', action)
                const result = next(action) // this will call dispatch since logger is the last middleware action. This is exactly like dispatch(action)
                console.log('The new state: ', store.getState())
                console.groupEnd()
                
                return result;
            }

            // Reducer needs to be a pure function
            // Reducer
            function todos(state = [], action) {
                switch (action.type) {
                    case ADD_TODO:
                        return state.concat([action.todo]);
                    case REMOVE_TODO:
                        return state.filter((todo) => todo.id !== action.id);
                    case TOGGLE_TODO:
                        return state.map((todo) =>
                            todo.id !== action.id
                            ? todo
                            : Object.assign({}, todo, { complete: !todo.complete })
                        );
                    case RECEIVE_DATA:
                        return action.todos
                    default:
                        state;
                }

                return state;
            }

            // Reducer
            function goals(state = [], action) {
                switch (action.type) {
                    case ADD_GOAL:
                        return state.concat([action.goal]);
                    case REMOVE_GOAL:
                        return state.filter((goal) => goal.id !== action.id);
                    case RECEIVE_DATA:
                        return action.goals
                    default:
                        return state;
                }
            }

            function loading(state = true, action){
                switch(action.type){
                    case RECEIVE_DATA:
                        return false
                    default : 
                        return state
                }
            }

            const store = Redux.createStore(Redux.combineReducers({
                todos,
                goals,
                loading,
            }), Redux.applyMiddleware(ReduxThunk.default, checker, logger));
        </script>

        <script type="text/babel">
            function List(props){

                return (
                    <ul>
                        {props.items.map((item) => (
                            <li key={item.id}>
                                <span                                 
                                    onClick={() => props.toggle && props.toggle(item.id)} 
                                    style={{textDecoration: item.complete ? 'line-through' : 'none'}}
                                >
                                    {item.name}
                                </span>
                                <button onClick={() => props.remove(item)}>X</button>
                            </li>
                        ))}
                    </ul>
                )
            }

            class Todos extends React.Component {
                addItem = (e) => {
                    e.preventDefault()

                    this.props.store.dispatch(handleAddTodo(
                        this.input.value, 
                        () =>{ this.input.value = '' }
                    ))
                }
                

                removeItem = (todo) => {
                    this.props.store.dispatch(handleDeleteTodo(todo))
                }

                toggleItem = (id) => {
                    this.props.store.dispatch(handleToggleTodo(id))
                }

                render() {
                    return (
                        <div>
                            <h1>Todo List</h1>
                            <input 
                                type='text'
                                placeholder='Add Todo'
                                ref={(input) => this.input = input} // uncontrolled component
                            />
                            <button onClick={this.addItem}>Add Todo</button>
                            
                            <List
                                items={this.props.todos}
                                remove={this.removeItem}
                                toggle={this.toggleItem}
                            />
                        </div>
                    )
                }
            }

            class Goals extends React.Component {
                addItem = (e) => {
                    e.preventDefault()

                    this.props.store.dispatch(handleAddGoal(
                        this.input.value,
                        () => this.input.value = '')
                    )
                }

                removeItem = (goal) => {
                    this.props.store.dispatch(handleDeleteGoal(goal))
                }

                render() {
                    return (
                        <div>
                            <h1>Goals</h1>
                            <input
                                type='text'
                                placeholder='Add Goal'
                                ref={(input) => this.input = input} // uncontrolled component
                            />
                            <button onClick={this.addItem}>Add Goal</button>
                            <List
                                items={this.props.goals}
                                remove={this.removeItem}
                            />
                        </div>
                    )
                }
            }

            class App extends React.Component {
                componentDidMount(){
                    const { store } = this.props

                    store.dispatch(handleInitialData())

                    store.subscribe(() => this.forceUpdate())
                }

                render() {
                    const { store } = this.props;
                    const {todos, goals, loading} = store.getState();

                    if(loading === true){
                        return <h3>Loading</h3>
                    }

                    return (
                        <div>
                            <Todos todos={todos} store={store}/>
                            <Goals goals={goals} store={store}/> 
                        </div>
                    )
                }
            }

            ReactDOM.render(
                <App store={store}/>,
                    document.getElementById('app')
            )
        </script>
    </body>
</html>